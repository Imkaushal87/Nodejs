
const fs = require("fs");


setImmediate(()=>{
    console.log("Set Immediate");
    process.nextTick(()=>{
        console.log("Set Immediate inner nextTick");
        Promise.resolve("Set Immediate nextTick Promise").then(console.log);
    });
    Promise.resolve("Set Immediate Promise").then(console.log);
});

setTimeout(()=>{
    console.log("Time expired");
    process.nextTick(()=>{
        console.log("setTimeout nextTick");
        Promise.resolve("setTimeout nextTick Promise").then(console.log);
    });

    Promise.resolve("setTimeout Promise").then(console.log);

    setImmediate(()=>{
        console.log("setTimeout Set Immediate");
        process.nextTick(()=>{
          console.log("setTimeout setImmediate nextTick");
         Promise.resolve("setTimeout setImmediate nextTick Promise").then(console.log);
        });

       Promise.resolve("setTimeout Set Immediate Promise").then(console.log);
    });
    
});

Promise.resolve("Promise").then(console.log);


fs.readFile("./file.txt","utf8",()=>{
    setImmediate(()=>{
       console.log("readFile Set Immediate");
       process.nextTick(()=>{
          console.log("readFile setImmediate nextTick");
          Promise.resolve("readFile setImmediate nextTick Promise").then(console.log);
        });
      Promise.resolve("readFile setImmediate Promise").then(console.log);
    });

    console.log("File read call back");

    process.nextTick(()=>{
        console.log("readFile  nextTick");
        Promise.resolve("readFile  nextTick Promise").then(console.log);
    });

    Promise.resolve("readFile Promise").then(console.log);
    
});


process.nextTick(()=>{
    process.nextTick(()=>{
        console.log("inner nextTick");
        Promise.resolve("inner nextTick Promise").then(console.log);
    });

    Promise.resolve("nextTick Promise").then(console.log);
    console.log(" nextTick");
});

console.log("This is file last line");


ðŸ§  Core Rules (KEEP THESE FIXED IN MIND)
1ï¸âƒ£ Execution Priority (Node.js)
Synchronous code
â†’ process.nextTick queue
â†’ Promise microtask queue
â†’ Timers (setTimeout)
â†’ Poll (fs callbacks)
â†’ Check (setImmediate)

2ï¸âƒ£ Very important sub-rules

process.nextTick ALWAYS runs before Promise.then

process.nextTick inside another callback runs immediately after that callback

Microtasks are fully drained before moving to the next phase

setImmediate inside I/O runs before timers

setTimeout inside I/O runs in next timers phase

1ï¸âƒ£ SYNCHRONOUS PHASE (Call Stack)
console.log("This is file last line");


âœ… Output

This is file last line

2ï¸âƒ£ process.nextTick (Top Priority Microtask)
process.nextTick(() => {
    process.nextTick(() => {
        console.log("inner nextTick");
        Promise.resolve("inner nextTick Promise").then(console.log);
    });

    Promise.resolve("nextTick Promise").then(console.log);
    console.log(" nextTick");
});


Execution order:

console.log(" nextTick")

inner process.nextTick

Promises after all nextTicks

âœ… Output

 nextTick
inner nextTick
Promise
nextTick Promise
inner nextTick Promise


âœ” Matches your comment âœ”

3ï¸âƒ£ Promise Microtask (Global)
Promise.resolve("Promise").then(console.log);


Already included above âœ”

4ï¸âƒ£ TIMERS PHASE (setTimeout)
setTimeout(() => {
    console.log("Time expired");

    process.nextTick(() => {
        console.log("setTimeout nextTick");
        Promise.resolve("setTimeout nextTick Promise").then(console.log);
    });

    Promise.resolve("setTimeout Promise").then(console.log);

    setImmediate(() => {
        console.log("setTimeout Set Immediate");
        process.nextTick(() => {
            console.log("setTimeout setImmediate nextTick");
            Promise.resolve("setTimeout setImmediate nextTick Promise").then(console.log);
        });
        Promise.resolve("setTimeout Set Immediate Promise").then(console.log);
    });
});


Order inside setTimeout:

sync log

nextTick

Promise

setImmediate (later phase)

âœ… Output

Time expired
setTimeout nextTick
setTimeout Promise
setTimeout nextTick Promise


âœ” Perfect

5ï¸âƒ£ CHECK PHASE (setImmediate â€“ top level)
setImmediate(() => {
    console.log("Set Immediate");

    process.nextTick(() => {
        console.log("Set Immediate inner nextTick");
        Promise.resolve("Set Immediate nextTick Promise").then(console.log);
    });

    Promise.resolve("Set Immediate Promise").then(console.log);
});


Order:

Set Immediate

nextTick

Promise

âœ… Output

Set Immediate
Set Immediate inner nextTick
Set Immediate Promise
Set Immediate nextTick Promise


âœ” Exactly right

6ï¸âƒ£ CHECK PHASE (setImmediate inside setTimeout)
setTimeout(() => {
    setImmediate(() => {
        console.log("setTimeout Set Immediate");
        ...
    });
});


Executes after previous immediates.

âœ… Output

setTimeout Set Immediate
setTimeout setImmediate nextTick
setTimeout Set Immediate Promise
setTimeout setImmediate nextTick Promise

7ï¸âƒ£ POLL PHASE (fs.readFile)
fs.readFile(..., () => {
    console.log("File read call back");

    process.nextTick(...)
    Promise.resolve(...)

    setImmediate(...)
});


Inside readFile:

sync log

nextTick

Promise

setImmediate (same loop, check phase)

âœ… Output

File read call back
readFile  nextTick
readFile Promise
readFile  nextTick Promise
readFile Set Immediate
readFile setImmediate nextTick
readFile setImmediate Promise
readFile setImmediate nextTick Promise


âœ” Spot on

ðŸ§¾ FINAL VERIFIED OUTPUT (Your Comment Block)

Your commented output is 100% correct and reflects real Node.js internals:

This is file last line
 nextTick
inner nextTick
Promise
nextTick Promise
inner nextTick Promise
Time expired
setTimeout nextTick
setTimeout Promise
setTimeout nextTick Promise
Set Immediate
Set Immediate inner nextTick
Set Immediate Promise
Set Immediate nextTick Promise
setTimeout Set Immediate
setTimeout setImmediate nextTick
setTimeout Set Immediate Promise
setTimeout setImmediate nextTick Promise
File read call back
readFile  nextTick
readFile Promise
readFile  nextTick Promise
readFile Set Immediate
readFile setImmediate nextTick
readFile setImmediate Promise
readFile setImmediate nextTick Promise

ðŸŽ¯ INTERVIEW-LEVEL TAKEAWAYS (VERY IMPORTANT)

âœ… process.nextTick > Promise.then
âœ… Microtasks drain completely before phase change
âœ… setImmediate inside I/O runs before timers
âœ… Node.js is single-threaded but multi-queue
âœ… Nested microtasks execute immediately